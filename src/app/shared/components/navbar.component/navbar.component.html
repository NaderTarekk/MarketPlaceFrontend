<app-loader-component *ngIf="isLoading"></app-loader-component>

<header class="navbar">
  <!-- ═══════════════════════════════════════════════ -->
  <!-- TOP ROW: Logo + Catalog + Search + Icons -->
  <!-- ═══════════════════════════════════════════════ -->
  <div class="navbar-top">
    <div class="navbar-container">
      <!-- Logo -->
      <div class="logo cursor-pointer" routerLink="">
        <img src="noqta logo rm.png" alt="MarketPlace Logo" class="logo-image" />
      </div>

      <!-- Catalog Button with Dropdown -->
      <div class="catalog-dropdown">
        <button class="catalog-btn" (click)="isCatalogOpen = !isCatalogOpen">
          <i class="fa-solid" [ngClass]="isCatalogOpen ? 'fa-times' : 'fa-grip'"></i>
          <span>{{ currentLang === 'ar' ? 'الأقسام' : 'Catalog' }}</span>
        </button>

        <!-- Categories Dropdown - Grid Style with Images -->
        <div class="catalog-menu" [class.open]="isCatalogOpen">
          <div class="catalog-header">
            <h3>{{ currentLang === 'ar' ? 'تصفح الأقسام' : 'Browse Categories' }}</h3>
            <button class="close-catalog" (click)="isCatalogOpen = false">
              <i class="fa-solid fa-times"></i>
            </button>
          </div>

          <div class="catalog-grid">
            <a *ngFor="let cat of categories" [routerLink]="['/products']" [queryParams]="{category: cat.id}"
              (click)="isCatalogOpen = false" class="catalog-card">
              <div class="catalog-card-image">
                <img [src]="getCategoryImage(cat.image)" [alt]="currentLang === 'ar' ? cat.nameAr : cat.nameEn"
                  (error)="handleImageError($event)" />
              </div>
              <span class="catalog-card-name">{{ currentLang === 'ar' ? cat.nameAr : cat.nameEn }}</span>
              <span class="catalog-card-count">{{ cat.productCount }} {{ currentLang === 'ar' ? 'منتج' : 'products'
                }}</span>
            </a>
          </div>

          <a routerLink="/products" (click)="isCatalogOpen = false" class="catalog-view-all">
            <span>{{ currentLang === 'ar' ? 'عرض كل المنتجات' : 'View All Products' }}</span>
            <i class="fa-solid fa-arrow-left"></i>
          </a>
        </div>
      </div>

      <!-- Backdrop for Catalog -->
      <div class="catalog-backdrop" *ngIf="isCatalogOpen" (click)="isCatalogOpen = false"></div>

      <!-- Search Bar - OZON Style -->
      <div class="search-wrapper-ozon desktop-search">
        <div class="search-input-ozon">
          <i class="fa-solid fa-search search-icon-ozon"></i>
          <input type="text" [placeholder]="currentLang === 'ar' ? 'ابحث في نقطة...' : 'Search on Noqta'"
            [(ngModel)]="searchQuery" (input)="onSearchInput($event)" (keyup.enter)="onSearch()"
            (focus)="searchQuery.length >= 2 && (showSearchDropdown = true)" />
          <button *ngIf="searchQuery" class="clear-btn-ozon" (click)="searchQuery = ''; showSearchDropdown = false">
            <i class="fa-solid fa-times"></i>
          </button>
          <button class="search-btn-ozon" (click)="onSearch()">
            <i *ngIf="!isSearching" class="fa-solid fa-magnifying-glass"></i>
            <i *ngIf="isSearching" class="fa-solid fa-spinner fa-spin"></i>
          </button>
        </div>

        <!-- Search Dropdown -->
        <div class="search-dropdown" *ngIf="showSearchDropdown && searchResults.length > 0">
          <div class="dropdown-header">
            <span>{{ currentLang === 'ar' ? 'نتائج البحث' : 'Search Results' }}</span>
            <button (click)="showSearchDropdown = false">
              <i class="fa-solid fa-times"></i>
            </button>
          </div>
          <div class="search-results">
            <a *ngFor="let product of searchResults" class="search-result-item"
              (mousedown)="selectSearchResult(product)">
              <div class="result-image">
                <img [src]="getProductImage(product.mainImage)" [alt]="getProductName(product)"
                  (error)="handleImageError($event)" />
              </div>
              <div class="result-info">
                <span class="result-name">{{ getProductName(product) }}</span>
                <div class="result-meta">
                  <span class="result-price">{{ product.price | number:'1.0-0' }} {{ currentLang === 'ar' ? 'ج.م' :
                    'EGP' }}</span>
                </div>
              </div>
              <i class="fa-solid fa-chevron-left result-arrow"></i>
            </a>
          </div>
          <button class="view-all-btn" (mousedown)="onSearch()">
            <span>{{ currentLang === 'ar' ? 'عرض كل النتائج' : 'View All Results' }}</span>
            <i class="fa-solid fa-arrow-left"></i>
          </button>
        </div>

        <!-- No Results -->
        <div class="search-dropdown"
          *ngIf="showSearchDropdown && searchResults.length === 0 && !isSearching && searchQuery.length >= 2">
          <div class="no-results">
            <i class="fa-solid fa-search"></i>
            <p>{{ currentLang === 'ar' ? 'لا توجد نتائج لـ' : 'No results for' }} "{{ searchQuery }}"</p>
          </div>
        </div>

        <!-- Backdrop -->
        <div class="search-backdrop" *ngIf="showSearchDropdown" (click)="showSearchDropdown = false"></div>
      </div>

      <!-- Nav Icons - OZON Style -->
      <div class="nav-icons-ozon desktop-icons">
        <button class="nav-icon-item" (click)="toggleLang()">
          <i class="fa-solid fa-globe"></i>
          <span>{{ currentLang === 'ar' ? 'EN' : 'عربي' }}</span>
        </button>

        <a *ngIf="!isLogged" routerLink="/auth/login" class="nav-icon-item">
          <i class="fa-solid fa-user"></i>
          <span>{{ 'login' | translate }}</span>
        </a>
        <a *ngIf="isLogged" routerLink="/auth/profile" class="nav-icon-item">
          <i class="fa-solid fa-user"></i>
          <span>{{ 'profile' | translate }}</span>
        </a>

        <a *ngIf="isLogged" routerLink="/cart/my-orders" class="nav-icon-item">
          <i class="fa-solid fa-box"></i>
          <span>{{ currentLang === 'ar' ? 'طلباتي' : 'Orders' }}</span>
        </a>

        <a routerLink="products/wishlist" class="nav-icon-item">
          <i class="fa-solid fa-heart"></i>
          <span>{{ 'fav' | translate }}</span>
        </a>

        <a routerLink="/cart" class="nav-icon-item cart-item">
          <div class="cart-icon-wrapper">
            <i class="fa-solid fa-cart-shopping"></i>
            <span *ngIf="cartCount > 0" class="cart-badge-ozon">{{ cartCount }}</span>
          </div>
          <span>{{ 'cart' | translate }}</span>
        </a>
      </div>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════ -->
  <!-- BOTTOM ROW: Navigation Links -->
  <!-- ═══════════════════════════════════════════════ -->
  <div class="navbar-bottom desktop-nav">
    <div class="navbar-container">
      <nav class="nav-links-ozon">
        <a routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" class="nav-link-ozon">
          <i class="fa-solid fa-house"></i>
          {{ 'home' | translate }}
        </a>
        <a routerLink="/products" routerLinkActive="active" class="nav-link-ozon">
          <i class="fa-solid fa-store"></i>
          {{ 'products' | translate }}
        </a>

        <!-- ✅ شريط الأصناف جوه الـ navbar -->
        <div class="categories-inline-track" *ngIf="categories.length > 0">

          <a *ngFor="let cat of categories"
          [routerLink]="['/products']"
          [queryParams]="{category: cat.id}"
          class="cat-pill-inline"
          routerLinkActive="cat-pill-inline--active"
          >
          <div class="cat-pill-inline-img">
            <img [src]="getCategoryImage(cat.image)" [alt]="currentLang === 'ar' ? cat.nameAr : cat.nameEn"
              (error)="handleImageError($event)" />
          </div>
          <span class="cat-pill-inline-name">
            {{ currentLang === 'ar' ? cat.nameAr : cat.nameEn }}
          </span>
          </a>
        </div>

        <div *ngIf="isAdmin" class="nav-dropdown">
          <button class="nav-link-ozon dropdown-trigger">
            <i class="fa-solid fa-shield-halved"></i>
            {{ currentLang === 'ar' ? 'الأدمن' : 'Admin' }}
            <i class="fa-solid fa-chevron-down chevron"></i>
          </button>
          <div class="dropdown-menu">
            <a *ngFor="let page of adminPages" [routerLink]="page.route" class="dropdown-item">
              <i class="fa-solid" [ngClass]="page.icon"></i>
              {{ currentLang === 'ar' ? page.nameAr : page.nameEn }}
            </a>
          </div>
        </div>

        <a *ngIf="isVendor" routerLink="/vendor" routerLinkActive="active" class="nav-link-ozon vendor-link">
          <i class="fa-solid fa-chart-line"></i>
          {{ 'dashboard' | translate }}
        </a>

        <button *ngIf="isLogged" (click)="logout()" class="nav-link-ozon logout-link">
          <i class="fa-solid fa-right-from-bracket"></i>
          {{ 'logout' | translate }}
        </button>
      </nav>
    </div>
  </div>
</header>


<div class="categories-scroll-bar" *ngIf="categories.length > 0">
  <div class="categories-scroll-track">

    <a *ngFor="let cat of categories" [routerLink]="['/products']" [queryParams]="{category: cat.id}" class="cat-pill"
      routerLinkActive="cat-pill--active">
      <div class="cat-pill-img">
        <img [src]="getCategoryImage(cat.image)" [alt]="currentLang === 'ar' ? cat.nameAr : cat.nameEn"
          (error)="handleImageError($event)" />
      </div>
      <span class="cat-pill-name">
        {{ currentLang === 'ar' ? cat.nameAr : cat.nameEn }}
      </span>
    </a>
  </div>
</div>
<!-- ═══════════════════════════════════════════════ -->
<!-- MOBILE BOTTOM NAV BAR -->
<!-- ═══════════════════════════════════════════════ -->
<nav class="mobile-bottom-nav">
  <a routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}" class="bottom-nav-item">
    <i class="fa-solid fa-house"></i>
    <span>{{ 'home' | translate }}</span>
  </a>


  <!-- <button (click)="toggleCategoriesMenu()" class="bottom-nav-item categories-nav-btn"
    [class.active]="isCategoriesMenuOpen">
    <div class="categories-icon-wrapper">
      <i class="fa-solid fa-grid-2"></i>
      <span class="categories-dot" *ngIf="categories.length > 0"></span>
    </div>
    <span>{{ 'categories' | translate }}</span>
  </button> -->

  <a *ngIf="isVendor" routerLink="/vendor" routerLinkActive="active" class="bottom-nav-item vendor-item">
    <i class="fa-solid fa-store"></i>
    <span>{{ currentLang === 'ar' ? 'متجري' : 'My Store' }}</span>
  </a>

  <button *ngIf="isAdmin" (click)="toggleAdminMenu()" class="bottom-nav-item" [class.active]="isAdminMenuOpen">
    <i class="fa-solid fa-shield-halved"></i>
    <span>{{ currentLang === 'ar' ? 'الأدمن' : 'Admin' }}</span>
  </button>

  <a routerLink="/cart" routerLinkActive="active" class="bottom-nav-item">
    <div class="relative">
      <i class="fa-solid fa-cart-shopping"></i>
      <span *ngIf="cartCount > 0" class="cart-badge">{{ cartCount }}</span>
    </div>
    <span>{{ 'cart' | translate }}</span>
  </a>

  <a *ngIf="!isVendor && !isAdmin" routerLink="products/wishlist" routerLinkActive="active" class="bottom-nav-item">
    <i class="fa-solid fa-heart"></i>
    <span>{{ 'fav' | translate }}</span>
  </a>

  <button *ngIf="isLogged" routerLink="/auth/profile" class="bottom-nav-item" [class.active]="isProfileMenuOpen">
    <i class="fa-solid fa-user"></i>
    <span>{{ 'profile' | translate }}</span>
  </button>
  <a *ngIf="!isLogged" routerLink="/auth/login" routerLinkActive="active" class="bottom-nav-item">
    <i class="fa-solid fa-right-to-bracket"></i>
    <span>{{ 'login' | translate }}</span>
  </a>
</nav>

<!-- ═══════════════════════════════════════════════ -->
<!-- CATEGORIES MENU POPUP - MOBILE (Grid with Images) -->
<!-- ═══════════════════════════════════════════════ -->
<div class="categories-menu-overlay" [class.open]="isCategoriesMenuOpen" (click)="toggleCategoriesMenu()">
  <div class="categories-menu" (click)="$event.stopPropagation()">
    <div class="categories-menu-header">
      <h3>{{ currentLang === 'ar' ? 'تصفح الأقسام' : 'Browse Categories' }}</h3>
      <button (click)="toggleCategoriesMenu()" class="close-btn">&times;</button>
    </div>

    <div class="categories-grid">
      <a *ngFor="let cat of categories" [routerLink]="['/products']" [queryParams]="{category: cat.id}"
        (click)="toggleCategoriesMenu()" class="category-card">
        <div class="category-card-image">
          <img [src]="getCategoryImage(cat.image)" [alt]="currentLang === 'ar' ? cat.nameAr : cat.nameEn"
            (error)="handleImageError($event)" />
        </div>
        <span class="category-card-name">{{ currentLang === 'ar' ? cat.nameAr : cat.nameEn }}</span>
        <span class="category-card-count">{{ cat.productCount }} {{ currentLang === 'ar' ? 'منتج' : 'items' }}</span>
      </a>
    </div>

    <a routerLink="/products" (click)="toggleCategoriesMenu()" class="categories-view-all">
      <span>{{ currentLang === 'ar' ? 'عرض كل المنتجات' : 'View All Products' }}</span>
      <i class="fa-solid fa-arrow-left"></i>
    </a>
  </div>
</div>

<!-- ═══════════════════════════════════════════════ -->
<!-- ADMIN MENU POPUP -->
<!-- ═══════════════════════════════════════════════ -->
<div class="admin-menu-overlay" [class.open]="isAdminMenuOpen" (click)="toggleAdminMenu()">
  <div class="admin-menu" (click)="$event.stopPropagation()">
    <div class="admin-menu-header">
      <h3>{{ currentLang === 'ar' ? 'صفحات الأدمن' : 'Admin Pages' }}</h3>
      <button (click)="toggleAdminMenu()" class="close-btn">&times;</button>
    </div>
    <div class="admin-menu-list">
      <button *ngFor="let page of adminPages" (click)="navigateToAdminPage(page.route)" class="admin-menu-item">
        <div class="admin-item-content">
          <i class="fa-solid" [ngClass]="page.icon"></i>
          <span>{{ currentLang === 'ar' ? page.nameAr : page.nameEn }}</span>
        </div>
        <i class="fa-solid fa-chevron-left"></i>
      </button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════ -->
<!-- VENDOR MENU POPUP -->
<!-- ═══════════════════════════════════════════════ -->
<div class="admin-menu-overlay" [class.open]="isVendorMenuOpen" (click)="toggleVendorMenu()">
  <div class="admin-menu" (click)="$event.stopPropagation()">
    <div class="admin-menu-header">
      <h3>{{ currentLang === 'ar' ? 'صفحات التاجر' : 'Vendor Pages' }}</h3>
      <button (click)="toggleVendorMenu()" class="close-btn">&times;</button>
    </div>
    <div class="admin-menu-list">
      <button *ngFor="let page of vendorPages" (click)="navigateToAdminPage(page.route)" class="admin-menu-item">
        <div class="admin-item-content">
          <i class="fa-solid" [ngClass]="page.icon"></i>
          <span>{{ currentLang === 'ar' ? page.nameAr : page.nameEn }}</span>
        </div>
        <i class="fa-solid fa-chevron-left"></i>
      </button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════ -->
<!-- PROFILE MENU POPUP -->
<!-- ═══════════════════════════════════════════════ -->
<div class="profile-menu-overlay" [class.open]="isProfileMenuOpen" (click)="toggleProfileMenu()">
  <div class="profile-menu" (click)="$event.stopPropagation()">
    <a routerLink="/auth/profile" (click)="toggleProfileMenu()" class="profile-menu-item">
      <i class="fa-solid fa-user-circle"></i>
      <span>{{ 'profile' | translate }}</span>
    </a>
    <button (click)="logout(); toggleProfileMenu()" class="profile-menu-item logout">
      <i class="fa-solid fa-right-from-bracket"></i>
      <span>{{ 'logout' | translate }}</span>
    </button>
  </div>
</div>

<!-- ═══════════════════════════════════════════════ -->
<!-- FIXED ACTION BUTTON -->
<!-- ═══════════════════════════════════════════════ -->
<div class="fixed-action-button">
  <button (click)="toggleActionMenu()" class="main-action-btn">
    <i class="fa-solid fa-ellipsis-vertical"></i>
  </button>

  <div class="action-menu-popup" [class.open]="isActionMenuOpen">
    <button (click)="toggleLang(); toggleActionMenu()" class="action-menu-item">
      <i class="fa-solid fa-language"></i>
      <span>{{ currentLang === 'ar' ? 'تغيير اللغة' : 'Change Language' }}</span>
    </button>
    <button (click)="toggleActionMenu()" class="action-menu-item">
      <i class="fa-solid fa-headset"></i>
      <span>{{ currentLang === 'ar' ? 'خدمة العملاء' : 'Customer Support' }}</span>
    </button>
  </div>
</div>